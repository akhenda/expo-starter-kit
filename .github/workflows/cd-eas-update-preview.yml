name: Deploy Preview

on:
  pull_request:
    branches:
      - dev
      - main

jobs:
  ci-lint-and-test:
    uses: ./.github/workflows/ci-lint-and-test.yml

  eas-update-preview:
    runs-on: ubuntu-latest
    name: EAS Update Preview
    environment: preview
    needs: [ci-lint-and-test]
    env:
      APP_VARIANT: ${{ vars.APP_VARIANT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: 🏗 Install PNPM packager
        uses: pnpm/action-setup@v2.2.4

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        uses: ./.github/actions/pnpm-install

      # - name: 🚀 Create preview update
      #   run: eas update --branch=preview --non-interactive --message "update preview channel to ${GITHUB_HEAD_REF}"

      # - name: 💬 Comment in preview
      #   uses: expo/expo-github-action/preview-comment@v7
      #   with:
      #     channel: preview

      # - name: Slack Notification
      #   uses: rtCamp/action-slack-notify@v2
      #   env:
      #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      #     SLACK_CHANNEL: REPLACE-ME
      #     SLACK_MESSAGE: ":rocket: Updated Preview app to ${{env.GITHUB_HEAD_REF}}"

      - name: 🚀 Create preview
        uses: expo/expo-github-action/preview@v8
        id: preview
        with:
          command: eas update --auto

      # Find the PR associated with this push, if there is one.
      - name: 📄 Get PR details
        uses: jwalton/gh-find-current-pr@v1
        id: findPr

      - name: 💬 Comment in Slack
        uses: slackapi/slack-github-action@v1.17.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
        with:
          channel-id: engineering
          slack-message: ':rocket: New Preview EAS update from PR #${{ steps.findPr.outputs.pr }} is available!\n- Preview: ${{ steps.preview.outputs.qr }}'
